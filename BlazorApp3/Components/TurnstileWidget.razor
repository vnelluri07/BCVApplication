@inject IJSRuntime JS
@inject Microsoft.Extensions.Configuration.IConfiguration Config

<div id="@_elementId"></div>

@code {
    [Parameter] public EventCallback<string> OnVerified { get; set; }

    private string _elementId = $"turnstile-{Guid.NewGuid():N}";
    private string? _widgetId;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var siteKey = Config["CloudflareTurnstile:SiteKey"];
            if (string.IsNullOrEmpty(siteKey) || siteKey.Contains("SET_VIA")) return;
            _widgetId = await JS.InvokeAsync<string>("bcvRenderTurnstile", _elementId, siteKey);
        }
    }

    public async Task<string?> GetResponseAsync()
    {
        if (_widgetId is null) return null;
        try
        {
            var token = await JS.InvokeAsync<string>("bcvGetTurnstileResponse", _widgetId);
            return string.IsNullOrEmpty(token) ? null : token;
        }
        catch { return null; }
    }

    public async Task ResetAsync()
    {
        if (_widgetId is not null)
            await JS.InvokeVoidAsync("bcvResetTurnstile", _widgetId);
    }
}

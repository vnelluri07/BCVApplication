@page "/create"
@using BeersCheersAndVasis.UI.Components.Pages.Script
@using BeersCheersVasis.Api.Models.Script
@using BlazorApp3.Services
@using TinyMCE.Blazor
@implements IDisposable

<PageTitle>Create Script â€” Beers Cheers & Vasis</PageTitle>

<section class="bcv-section">
    <div class="bcv-container" style="max-width:960px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
            <h1>Create Script</h1>
            <span class="bcv-save-indicator @SaveIndicatorClass">@saveStatusText</span>
        </div>

        <div class="bcv-editor-wrap">
            <input type="text" placeholder="Title" class="bcv-input bcv-input-lg"
                   @bind="title" @bind:event="oninput" @bind:after="OnContentChanged" />

            <h3 class="bcv-mt-md bcv-mb-md">Script / Content</h3>

            <Editor ScriptSrc="lib/tinymce/tinymce.min.js"
                    Id="bcv-editor"
                    @bind-Value="htmlContent"
                    Conf="@editorConf"
                    ClassName="bcv-editor" />

            <div style="display:flex; gap:0.5rem; margin-top:0.75rem;">
                <button class="bcv-btn bcv-btn-sm" @onclick="OpenEmbedDialog">ðŸ”— Embed Link</button>
            </div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:1rem;">
                <span class="bcv-text-muted" style="font-size:0.85rem;">@WordCount words</span>
                <button class="bcv-btn bcv-btn-primary" @onclick="OnPublishClick">Publish</button>
            </div>
        </div>
    </div>
</section>

@code {
    [Inject] private ScriptController Controller { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;
    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private CreateScriptStateService State { get; set; } = default!;

    private string htmlContent = string.Empty;
    private string title = string.Empty;
    private long WordCount;

    private int? _scriptId;
    private Timer? _debounceTimer;
    private bool _isSaving;
    private string saveStatusText = string.Empty;
    private const int DebounceMs = 500;

    private bool _saveFailed;
    private string SaveIndicatorClass => _isSaving ? "saving" : _saveFailed ? "failed" : "saved";

    private Dictionary<string, object> editorConf = new()
    {
        { "license_key", "gpl" },
        { "plugins", "lists link image code media table wordcount autolink fullscreen noneditable" },
        { "toolbar", "undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | " +
                     "alignleft aligncenter alignright | bullist numlist | link image media | fullscreen | code | removeformat" },
        { "height", 520 },
        { "toolbar_mode", "wrap" },
        { "menubar", "file edit view insert format tools table" },
        { "content_css", "/css/editor-content.css" },
        { "font_family_formats",
            "Noto Sans=Noto Sans, Noto Sans Devanagari, Noto Sans Telugu, Noto Sans Arabic, sans-serif;" +
            "Arial=arial,helvetica,sans-serif;" +
            "Courier New=courier new,courier,monospace;" +
            "Georgia=georgia,palatino,serif" },
        { "font_size_formats", "12px 14px 16px 18px 20px 24px 28px 32px 36px 48px" },
        { "skin", "oxide" },
        { "promotion", false },
        { "branding", false },
        { "image_advtab", true },
        { "automatic_uploads", true },
        { "file_picker_types", "image" },
        { "block_formats", "Paragraph=p; Heading 1=h1; Heading 2=h2; Heading 3=h3; Code=pre" },
        { "sandbox_iframes", false },
        { "extended_valid_elements", "iframe[src|width|height|frameborder|allowfullscreen|allow|style|class],div[class|contenteditable|style]" }
    };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await State.LoadAsync();
            title = State.Title;
            htmlContent = State.HtmlContent;
            _scriptId = State.ScriptId;
            UpdateWordCount();

            if (_scriptId is not null)
                saveStatusText = "Saved âœ“";

            StateHasChanged();
        }
    }

    private async Task OpenEmbedDialog()
    {
        var dialog = await DialogService.ShowAsync<LinkPreviewDialog>("Embed Link",
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is string cardHtml)
        {
            await JS.InvokeVoidAsync("bcvEditor.insertContent", "bcv-editor", cardHtml);
        }
    }

    private async void OnContentChanged()
    {
        UpdateWordCount();
        await PersistStateAsync();

        if (string.IsNullOrWhiteSpace(title) && string.IsNullOrWhiteSpace(htmlContent))
            return;

        _debounceTimer?.Dispose();
        _debounceTimer = new Timer(async _ => await InvokeAsync(SaveAsync), null, DebounceMs, Timeout.Infinite);
    }

    private async Task PersistStateAsync()
    {
        State.Title = title;
        State.HtmlContent = htmlContent;
        State.ScriptId = _scriptId;
        await State.SaveAsync();
    }

    private void UpdateWordCount()
    {
        var text = System.Text.RegularExpressions.Regex.Replace(htmlContent ?? "", "<[^>]+>", " ");
        WordCount = string.IsNullOrWhiteSpace(text)
            ? 0
            : text.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private async Task SaveAsync()
    {
        try
        {
            _isSaving = true;
            _saveFailed = false;
            saveStatusText = "Saving...";
            StateHasChanged();

            if (_scriptId is null)
            {
                var request = new CreateScriptRequest
                {
                    Title = title,
                    Content = htmlContent,
                    CreatedBy = 0022
                };
                var response = await Controller.CreateScript(request);
                _scriptId = response.Id;
            }
            else
            {
                var request = new UpdateScriptRequest
                {
                    Id = _scriptId.Value,
                    Title = title,
                    Content = htmlContent,
                    ModifiedBy = 0022
                };
                await Controller.UpdateScript(request);
            }

            await PersistStateAsync();
            _isSaving = false;
            saveStatusText = "Saved âœ“";
        }
        catch
        {
            _isSaving = false;
            _saveFailed = true;
            saveStatusText = "Save failed";
        }

        StateHasChanged();
    }

    private async Task OnPublishClick()
    {
        UpdateWordCount();
        var request = new CreateScriptRequest
        {
            Title = title,
            Content = htmlContent,
            CreatedBy = 0022
        };

        var response = await Controller.CreateScript(request);
        Snackbar.Add($"Published: {response.Title}", Severity.Success);

        await State.ClearAsync();
    }

    public void Dispose()
    {
        _debounceTimer?.Dispose();
    }
}

@page "/create"
@using BeersCheersAndVasis.UI.Components.Pages.Script
@using BeersCheersVasis.Api.Models.Script
@using BlazorApp3.Services
@using TinyMCE.Blazor
@implements IDisposable

<div class="page-container">
    <div class="title-save-row">
        <MudText Typo="Typo.h5" Class="page-title">Create Script</MudText>
        <MudText Typo="Typo.body2" Class="@SaveIndicatorClass">@saveStatusText</MudText>
    </div>

    <MudPaper Class="mud-paper rounded editor-container mt-4">
        <MudTextField T="string"
                      Class="title-field"
                      Placeholder="Title"
                      FullWidth="true"
                      Immediate="true"
                      @bind-Value="title"
                      @bind-Value:after="OnContentChanged" />

        <MudText Typo="Typo.h6" Class="mt-4 mb-2">Script / Content</MudText>

        <Editor ScriptSrc="lib/tinymce/tinymce.min.js"
                @bind-Value="htmlContent"
                Conf="@editorConf"
                ClassName="bcv-editor" />

        <div class="editor-actions mt-2">
            <MudButton OnClick="OpenEmbedDialog" Variant="Variant.Outlined" Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Link" Size="Size.Small">
                Embed Link
            </MudButton>
        </div>

        <div class="word-count-publish mt-3">
            <MudText Typo="Typo.body2" Class="word-count">@WordCount words</MudText>
            <MudButton OnClick="@OnPublishClick" Color="Color.Secondary" Variant="Variant.Filled">Publish</MudButton>
        </div>
    </MudPaper>
</div>

@code {
    [Inject] private ScriptController Controller { get; set; } = default!;
    [Inject] private ISnackbar Snackbar { get; set; } = default!;
    [Inject] private IDialogService DialogService { get; set; } = default!;
    [Inject] private IJSRuntime JS { get; set; } = default!;
    [Inject] private CreateScriptStateService State { get; set; } = default!;

    private string htmlContent = string.Empty;
    private string title = string.Empty;
    private long WordCount;

    private int? _scriptId;
    private Timer? _debounceTimer;
    private bool _isSaving;
    private string saveStatusText = string.Empty;
    private const int DebounceMs = 500;

    private string SaveIndicatorClass => _isSaving ? "save-indicator saving" : "save-indicator saved";

    private Dictionary<string, object> editorConf = new()
    {
        { "plugins", "lists link image code media table wordcount autolink" },
        { "toolbar", "undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | " +
                     "alignleft aligncenter alignright | bullist numlist | link image media | code | removeformat" },
        { "height", 520 },
        { "menubar", "file edit view insert format tools table" },
        { "content_css", "/css/editor-content.css" },
        { "font_family_formats",
            "Noto Sans=Noto Sans, Noto Sans Devanagari, Noto Sans Telugu, Noto Sans Arabic, sans-serif;" +
            "Arial=arial,helvetica,sans-serif;" +
            "Courier New=courier new,courier,monospace;" +
            "Georgia=georgia,palatino,serif" },
        { "font_size_formats", "12px 14px 16px 18px 20px 24px 28px 32px 36px 48px" },
        { "skin", "oxide" },
        { "promotion", false },
        { "branding", false },
        { "image_advtab", true },
        { "automatic_uploads", true },
        { "file_picker_types", "image" },
        { "block_formats", "Paragraph=p; Heading 1=h1; Heading 2=h2; Heading 3=h3; Code=pre" }
    };

    protected override void OnInitialized()
    {
        // Restore state from previous navigation
        title = State.Title;
        htmlContent = State.HtmlContent;
        _scriptId = State.ScriptId;
        UpdateWordCount();

        if (_scriptId is not null)
            saveStatusText = "Saved ✓";
    }

    private async Task OpenEmbedDialog()
    {
        var dialog = await DialogService.ShowAsync<LinkPreviewDialog>("Embed Link",
            new DialogOptions { MaxWidth = MaxWidth.Small, FullWidth = true });
        var result = await dialog.Result;

        if (result is not null && !result.Canceled && result.Data is string cardHtml)
        {
            await JS.InvokeVoidAsync("tinymce.activeEditor.insertContent", cardHtml);
        }
    }

    private void OnContentChanged()
    {
        UpdateWordCount();
        PersistState();

        if (string.IsNullOrWhiteSpace(title) && string.IsNullOrWhiteSpace(htmlContent))
            return;

        _debounceTimer?.Dispose();
        _debounceTimer = new Timer(async _ => await InvokeAsync(SaveAsync), null, DebounceMs, Timeout.Infinite);
    }

    private void PersistState()
    {
        State.Title = title;
        State.HtmlContent = htmlContent;
        State.ScriptId = _scriptId;
    }

    private void UpdateWordCount()
    {
        var text = System.Text.RegularExpressions.Regex.Replace(htmlContent ?? "", "<[^>]+>", " ");
        WordCount = string.IsNullOrWhiteSpace(text)
            ? 0
            : text.Split(new[] { ' ', '\n', '\r', '\t' }, StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private async Task SaveAsync()
    {
        try
        {
            _isSaving = true;
            saveStatusText = "Saving...";
            StateHasChanged();

            if (_scriptId is null)
            {
                var request = new CreateScriptRequest
                {
                    Title = title,
                    Content = htmlContent,
                    CreatedBy = 0022
                };
                var response = await Controller.CreateScript(request);
                _scriptId = response.Id;
            }
            else
            {
                var request = new UpdateScriptRequest
                {
                    Id = _scriptId.Value,
                    Title = title,
                    Content = htmlContent,
                    ModifiedBy = 0022
                };
                await Controller.UpdateScript(request);
            }

            PersistState();
            _isSaving = false;
            saveStatusText = "Saved ✓";
        }
        catch
        {
            _isSaving = false;
            saveStatusText = "Save failed";
        }

        StateHasChanged();
    }

    private async Task OnPublishClick()
    {
        UpdateWordCount();
        var request = new CreateScriptRequest
        {
            Title = title,
            Content = htmlContent,
            CreatedBy = 0022
        };

        var response = await Controller.CreateScript(request);
        Snackbar.Add($"Published: {response.Title}", Severity.Success);

        // Clear state after publish
        State.Title = string.Empty;
        State.HtmlContent = string.Empty;
        State.ScriptId = null;
    }

    public void Dispose()
    {
        PersistState();
        _debounceTimer?.Dispose();
    }
}

<style>
    .page-container {
        padding-top: 4em;
        max-width: 960px;
        margin: 0 auto;
    }

    .title-save-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .save-indicator {
        font-style: italic;
        transition: opacity 0.3s ease;
    }

    .save-indicator.saving {
        color: #ff9800;
    }

    .save-indicator.saved {
        color: #4caf50;
    }

    .editor-container {
        padding: 24px;
        background-color: #f7f7f7;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    .title-field {
        padding: 10px;
        font-size: 20px;
        height: 55px;
        width: 100%;
        border: 1px solid #ccc;
        border-radius: 5px;
        background-color: #ffffff;
        margin-bottom: 1em;
    }

    .editor-actions {
        display: flex;
        gap: 8px;
    }

    .word-count {
        color: #555;
    }

    .word-count-publish {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
</style>

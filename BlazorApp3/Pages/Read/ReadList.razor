@page "/read"
@page "/read/{CategoryId:int}"
@inject BeersCheersVasis.Api.Client.IScriptApi ScriptApi
@inject BeersCheersVasis.Api.Client.ICategoryApi CategoryApi
@inject NavigationManager Nav

<PageTitle>@(_categoryName ?? "Read") ‚Äî Beers Cheers & Vasis</PageTitle>

<section class="bcv-section">
    <div class="bcv-container">
        <h1 class="bcv-text-center">@(_categoryName ?? "All Writing")</h1>
        <p class="bcv-text-center bcv-text-muted bcv-mb-lg">
            @if (_categoryName is not null)
            {
                <a href="/read" style="text-decoration: underline;">‚Üê All categories</a>
            }
        </p>

        <!-- Search bar -->
        <div style="max-width:400px; margin:0 auto var(--bcv-space-xl);">
            <input @bind="_search" @bind:event="oninput" placeholder="Search by title..."
                style="width:100%; padding:0.5rem 0.75rem; border:1px solid var(--bcv-border); font-family:var(--bcv-font-body); font-size:0.9rem;" />
        </div>

        @if (_scripts is null)
        {
            <div class="bcv-card-grid">
                @for (var i = 0; i < 3; i++)
                {
                    <div class="bcv-card">
                        <div class="bcv-card-body">
                            <div class="bcv-skeleton bcv-skeleton-line" style="width:30%; margin-bottom:0.75rem;"></div>
                            <div class="bcv-skeleton bcv-skeleton-title"></div>
                            <div class="bcv-skeleton bcv-skeleton-line"></div>
                            <div class="bcv-skeleton bcv-skeleton-line" style="width:70%"></div>
                        </div>
                    </div>
                }
            </div>
        }
        else if (!FilteredScripts.Any())
        {
            <p class="bcv-text-center bcv-text-muted">
                @(string.IsNullOrWhiteSpace(_search) ? "Nothing published yet. Check back soon." : "No scripts match your search.")
            </p>
        }
        else
        {
            <div class="bcv-card-grid">
                @foreach (var script in PagedScripts)
                {
                    <div class="bcv-card" @onclick="() => GoToScript(script.Id)">
                        <div class="bcv-card-body">
                            <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.75rem;">
                                @if (!string.IsNullOrEmpty(script.CategoryName))
                                {
                                    <span class="bcv-badge">@script.CategoryName</span>
                                }
                                @{ var chip = GetFreshnessChip(script.PublishedDate ?? script.CreatedDate); }
                                @if (chip is not null)
                                {
                                    <span class="bcv-badge @chip.Value.css">@chip.Value.label</span>
                                }
                            </div>
                            <div class="bcv-card-title">@script.Title</div>
                            <div class="bcv-card-excerpt">@GetExcerpt(script.Content)</div>
                            <div class="bcv-card-meta">
                                @(script.PublishedDate?.ToString("MMMM d, yyyy") ?? script.CreatedDate?.ToString("MMMM d, yyyy"))
                                @if (script.CommentCount > 0)
                                {
                                    <span> ¬∑ @script.CommentCount @(script.CommentCount == 1 ? "comment" : "comments")</span>
                                }
                            </div>
                        </div>
                    </div>
                }
            </div>

            @if (TotalPages > 1)
            {
                <div style="display:flex; justify-content:center; gap:0.5rem; margin-top:2rem;">
                    <button class="bcv-btn-sm" disabled="@(_page <= 1)" @onclick="() => _page--">‚Üê Prev</button>
                    <span class="bcv-text-muted" style="padding:0.3rem 0.5rem;">@_page / @TotalPages</span>
                    <button class="bcv-btn-sm" disabled="@(_page >= TotalPages)" @onclick="() => _page++">Next ‚Üí</button>
                </div>
            }
        }
    </div>
</section>

@code {
    [Parameter] public int? CategoryId { get; set; }

    private IEnumerable<BeersCheersVasis.Api.Models.Script.ScriptResponse>? _scripts;
    private string? _categoryName;
    private string _search = "";
    private int _page = 1;
    private const int PageSize = 9;

    private IEnumerable<BeersCheersVasis.Api.Models.Script.ScriptResponse> FilteredScripts =>
        string.IsNullOrWhiteSpace(_search)
            ? _scripts!
            : _scripts!.Where(s => s.Title?.Contains(_search, StringComparison.OrdinalIgnoreCase) == true);

    private IEnumerable<BeersCheersVasis.Api.Models.Script.ScriptResponse> PagedScripts =>
        FilteredScripts.Skip((_page - 1) * PageSize).Take(PageSize);

    private int TotalPages => (int)Math.Ceiling(FilteredScripts.Count() / (double)PageSize);

    protected override async Task OnParametersSetAsync()
    {
        _scripts = null;
        try
        {
            if (CategoryId.HasValue)
            {
                _scripts = await ScriptApi.GetPublishedAsync(CategoryId.Value);
                var cat = await CategoryApi.GetAsync(CategoryId.Value);
                _categoryName = cat?.Name;
            }
            else
            {
                _scripts = await ScriptApi.GetPublishedAsync();
                _categoryName = null;
            }
        }
        catch
        {
            _scripts = Enumerable.Empty<BeersCheersVasis.Api.Models.Script.ScriptResponse>();
        }
    }

    private static (string label, string css)? GetFreshnessChip(DateTime? date)
    {
        if (date is null) return null;
        var age = DateTime.UtcNow - date.Value;
        if (age.TotalDays <= 7) return ("üî• Latest", "bcv-badge-latest");
        if (age.TotalDays <= 15) return ("‚ú® New", "bcv-badge-new");
        if (date.Value.Year == DateTime.UtcNow.Year && date.Value.Month == DateTime.UtcNow.Month)
            return ("üìÖ This Month", "bcv-badge-month");
        return null;
    }

    private static string GetExcerpt(string? html)
    {
        if (string.IsNullOrEmpty(html)) return "";
        var text = System.Text.RegularExpressions.Regex.Replace(html, "<[^>]+>", " ");
        text = System.Net.WebUtility.HtmlDecode(text);
        text = System.Text.RegularExpressions.Regex.Replace(text, @"\s+", " ").Trim();
        return text.Length > 160 ? text[..160] + "‚Ä¶" : text;
    }

    private void GoToScript(int id) => Nav.NavigateTo($"/read/script/{id}");
}
